<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Products (Medicines)</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'registration/sidebarstyles.css' %}">
    <link rel="stylesheet" href="{% static 'registration/userliststyles.css' %}">
</head>
<body>
<div class="container">
    {% include 'shared/sidebar.html' %}

    <div class="main-content">
        <h2>Products (Medicines)</h2>

        {% if messages %}
            <div style="margin-bottom: 20px;">
                {% for message in messages %}
                    <div style="padding: 10px; margin-bottom: 10px; border-radius: 4px; 
                                {% if message.tags == 'success' %}background: #d4edda; color: #155724;{% endif %}
                                {% if message.tags == 'error' %}background: #f8d7da; color: #721c24;{% endif %}
                                {% if message.tags == 'info' %}background: #d1ecf1; color: #0c5460;{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <div class="search-form">
            <form method="get" style="display: flex; gap: 10px; flex: 1;">
                <input type="text" name="search" placeholder="Search products..." value="{{ request.GET.search }}" style="flex: 1;">
                <button type="submit">Search</button>
            </form>
            <button type="button" class="btn-create" data-url="{% url 'medicine-add-modal' %}" onclick="openModal(this.getAttribute('data-url'))" style="text-decoration: none; display: inline-block; line-height: 1.5; border: none; cursor: pointer;">+ Add Product</button>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Brand</th>
                        <th>Category</th>
                        <th>Product Type</th>
                        <th>Dosage Form</th>
                        <th>Strength</th>
                        <th>Base Price</th>
                        <th>Selling Price</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                {% for medicine in medicines %}
                    <tr>
                        <td>{{ medicine.name }}</td>
                        <td>{{ medicine.brand|default:"-" }}</td>
                        <td>{{ medicine.category.name|default:"-" }}</td>
                        <td>{{ medicine.product_type.name|default:"-" }}</td>
                        <td>{{ medicine.get_dosage_form_display|default:"-" }}</td>
                        <td>{{ medicine.strength|default:"-" }}</td>
                        <td>â‚±{{ medicine.base_price|floatformat:2 }}</td>
                        <td>â‚±{{ medicine.selling_price|floatformat:2 }}</td>
                        <td>
                            <div class="action-buttons">
                                <button type="button" class="block-btn" data-url="{% url 'medicine-update-modal' medicine.id %}" onclick="openModal(this.getAttribute('data-url'))">Edit</button>
                                {% if is_manager_or_admin %}
                                    <button type="button" class="block-btn" data-url="{% url 'medicine-price-update-modal' medicine.id %}" onclick="openModal(this.getAttribute('data-url'))" title="Update Price Only">ðŸ’° Price</button>
                                {% endif %}
                                <form action="{% url 'medicine-delete' medicine.id %}" method="post" style="display:inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="block-btn" onclick="return confirm('Are you sure you want to delete this product?')">Delete</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="9" style="text-align:center;">No products found.</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    function toggleDropdown(dropdownId) {
        const dropdown = document.getElementById(dropdownId);
        const dropdownLi = dropdown.parentElement;
        
        // Toggle the 'open' class on both the dropdown menu and the parent li
        dropdown.classList.toggle('open');
        dropdown.classList.toggle('show');
        dropdownLi.classList.toggle('open');
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', function(event) {
        if (!event.target.closest('.dropdown')) {
            var allDropdowns = document.querySelectorAll('.dropdown-menu');
            var allParents = document.querySelectorAll('.dropdown');
            allDropdowns.forEach(function(dd) {
                dd.classList.remove('show');
            });
            allParents.forEach(function(parent) {
                parent.classList.remove('open');
            });
        }
    });

    // Modal logic
    function openModal(fetchUrl) {
        const modal = document.getElementById('generic-modal');
        const modalContent = document.getElementById('generic-modal-content');
        modalContent.innerHTML = '<div style="padding:20px;">Loading...</div>';
        modal.style.display = 'flex';
        fetch(fetchUrl, {headers: {'X-Requested-With': 'XMLHttpRequest'}})
            .then(r => r.json())
            .then(data => {
                if (data.html) {
                    modalContent.innerHTML = data.html;
                    attachModalFormHandler(modalContent);
                } else {
                    modalContent.innerHTML = '<div style="padding:20px;color:red;">Failed to load form.</div>';
                }
            })
            .catch(err => {
                console.error('Modal fetch error:', err);
                modalContent.innerHTML = '<div style="padding:20px;color:red;">Error loading form.</div>';
            });
    }
    
    function closeModal() {
        const modal = document.getElementById('generic-modal');
        modal.style.display = 'none';
    }
    
    function attachModalFormHandler(container) {
        const form = container.querySelector('form');
        if (!form) return;
        form.addEventListener('submit', function(e){
            e.preventDefault();
            const formData = new FormData(form);
            fetch(form.getAttribute('action') || window.location.href, {
                method: 'POST',
                headers: {'X-Requested-With': 'XMLHttpRequest'},
                body: formData
            }).then(r => r.json())
              .then(data => {
                  if (data.success) {
                      closeModal();
                      window.location.reload();
                  } else if (data.html) {
                      container.innerHTML = data.html;
                      attachModalFormHandler(container);
                  } else if (data.error) {
                      alert('Error: ' + data.error);
                  } else {
                      alert('Save failed');
                  }
              }).catch(err => {
                  console.error('Form submit error:', err);
                  alert('Network error');
              });
        });
    }

    // Close modal on outside click
    window.addEventListener('click', function(e){
        const modal = document.getElementById('generic-modal');
        if (e.target === modal) closeModal();
    });
</script>

<div id="generic-modal" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:1000;">
    <div id="generic-modal-content" style="background:#fff;min-width:480px;max-width:800px;width:70%;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.3);overflow-y:auto;max-height:90vh;padding:10px;">
        <!-- Dynamic content injected here -->
    </div>
</div>

</body>
</html>

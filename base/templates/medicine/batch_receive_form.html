<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Receive Purchase Order</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'registration/sidebarstyles.css' %}">
    <link rel="stylesheet" href="{% static 'registration/userliststyles.css' %}">
    <style>
        .items-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .items-table thead { background: #f44336; color: white; }
        .items-table th, .items-table td { padding: 12px; text-align: left; border: 1px solid #ddd; }
        .items-table tbody tr:hover { background: #f5f5f5; }
        .items-table input[type="number"] { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .form-actions { display: flex; gap: 10px; margin-top: 20px; }
        .ordered-qty { font-weight: 600; color: #2196F3; }
        .remaining-qty { font-size: 12px; color: #666; margin-left: 10px; }
    </style>
</head>
<body>
<div class="container">
    {% include 'shared/sidebar.html' %}

    <div class="main-content">
        <h2>Receive Batch from Purchase Order</h2>
        <p style="color: #666; margin-bottom: 20px;">Enter the quantity received and damaged for each medicine in the purchase order.</p>

        {% if messages %}
            <div style="margin-bottom: 20px;">
                {% for message in messages %}
                    <div style="padding: 12px; margin-bottom: 10px; border-radius: 4px; 
                                {% if message.tags == 'success' %}background: #d4edda; color: #155724;{% endif %}
                                {% if message.tags == 'error' %}background: #f8d7da; color: #721c24;{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <form method="post" id="batch-receive-form">
            {% csrf_token %}
            
            <div style="background: #e3f2fd; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                <label style="display: block; font-weight: 500; margin-bottom: 8px;">Select Purchase Order</label>
                <select name="purchase_order" id="purchase-order-select" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                    <option value="">-- Select Received Purchase Order --</option>
                    {% for po in purchase_orders %}
                    <option value="{{ po.id }}" {% if selected_po and selected_po.id == po.id %}selected{% endif %}>
                        PO #{{ po.id }} - {{ po.po_date|date:"M d, Y" }} ({{ po.lines.count }} items)
                    </option>
                    {% endfor %}
                </select>
            </div>

            {% if selected_po %}
            <div style="background: #fff3cd; padding: 15px; border-radius: 4px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                <strong>Purchase Order #{{ selected_po.id }}</strong> - Date: {{ selected_po.po_date|date:"M d, Y" }}
                {% if selected_po.notes %}
                <br><span style="color: #666;">Notes: {{ selected_po.notes }}</span>
                {% endif %}
            </div>

            <div style="background: #f9f9f9; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                <label style="display: block; font-weight: 500; margin-bottom: 8px;">Date Received</label>
                <input type="date" name="date_received" required value="{% now 'Y-m-d' %}" style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
            </div>

            <table class="items-table">
                <thead>
                    <tr>
                        <th style="width: 30%;">Medicine</th>
                        <th style="width: 15%;">Ordered Qty</th>
                        <th style="width: 15%;">Already Received</th>
                        <th style="width: 18%;">Received (Good Boxes)</th>
                        <th style="width: 18%;">Damaged (Boxes)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for line in selected_po.lines.all %}
                    {% with remaining=line.quantity_ordered|add:"-"|add:line.quantity_received %}
                    <tr {% if line.quantity_received >= line.quantity_ordered %}style="opacity: 0.5; background: #f0f0f0;"{% endif %}>
                        <td>
                            <strong>{{ line.medicine.name }}</strong>
                            <input type="hidden" name="line_id[]" value="{{ line.id }}">
                            {% if line.quantity_received >= line.quantity_ordered %}
                            <br><span style="color: #4CAF50; font-size: 12px;">âœ“ Fully Received</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="ordered-qty">{{ line.quantity_ordered }} boxes</span>
                        </td>
                        <td>
                            <span style="color: #2196F3; font-weight: 500;">{{ line.quantity_received }} boxes</span>
                        </td>
                        <td>
                            {% with remaining_qty=line.quantity_ordered|add:line.quantity_received|add:"-" %}
                            <input type="number" name="quantity_received_{{ line.id }}" min="0" max="{{ remaining_qty|floatformat:"0" }}" value="0" class="received-input" data-line-id="{{ line.id }}" data-ordered="{{ line.quantity_ordered }}" data-already-received="{{ line.quantity_received }}" {% if line.quantity_received >= line.quantity_ordered %}disabled{% endif %}>
                            {% endwith %}
                        </td>
                        <td>
                            {% with remaining_qty=line.quantity_ordered|add:line.quantity_received|add:"-" %}
                            <input type="number" name="quantity_damaged_{{ line.id }}" min="0" max="{{ remaining_qty|floatformat:"0" }}" value="0" class="damaged-input" data-line-id="{{ line.id }}" data-ordered="{{ line.quantity_ordered }}" data-already-received="{{ line.quantity_received }}" {% if line.quantity_received >= line.quantity_ordered %}disabled{% endif %}>
                            {% endwith %}
                        </td>
                    </tr>
                    {% endwith %}
                    {% endfor %}
                </tbody>
            </table>

            <div class="form-actions">
                <button type="submit" style="padding: 12px 30px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; font-size: 14px;">Receive Batch</button>
                <a href="{% url 'batch-list' %}" style="padding: 12px 30px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; text-decoration: none; display: inline-block; font-weight: 500; font-size: 14px;">Cancel</a>
            </div>
            {% else %}
            <div style="text-align: center; padding: 40px; color: #999;">
                <p>Please select a purchase order to receive batch items.</p>
            </div>
            {% endif %}
        </form>
    </div>
</div>

<script>
// Auto-submit when PO is selected
document.getElementById('purchase-order-select').addEventListener('change', function() {
    if (this.value) {
        window.location.href = '?po=' + this.value;
    }
});

// Validate quantities
document.getElementById('batch-receive-form').addEventListener('submit', function(e) {
    const receivedInputs = document.querySelectorAll('.received-input');
    const damagedInputs = document.querySelectorAll('.damaged-input');
    let hasError = false;
    let hasAnyQuantity = false;

    receivedInputs.forEach((receivedInput, index) => {
        if (receivedInput.disabled) return; // Skip disabled inputs
        
        const lineId = receivedInput.dataset.lineId;
        const ordered = parseInt(receivedInput.dataset.ordered);
        const alreadyReceived = parseInt(receivedInput.dataset.alreadyReceived) || 0;
        const received = parseInt(receivedInput.value) || 0;
        const damagedInput = document.querySelector(`[name="quantity_damaged_${lineId}"]`);
        const damaged = parseInt(damagedInput.value) || 0;
        const total = received + damaged + alreadyReceived;

        if (received > 0) hasAnyQuantity = true;

        if (total > ordered) {
            alert(`Error: Total (already received: ${alreadyReceived} + new received: ${received} + damaged: ${damaged}) = ${total} boxes exceeds ordered quantity (${ordered} boxes) for this item.`);
            hasError = true;
            receivedInput.focus();
            return false;
        }
    });

    if (!hasAnyQuantity) {
        alert('Please enter at least one quantity received.');
        hasError = true;
    }

    if (hasError) {
        e.preventDefault();
        return false;
    }
});
</script>
</body>
</html>
